// api/send.js - Vercel Serverless UDP Flood (تعليمي فقط)
export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'فقط GET مسموح' });
  }

  const { ip, port } = req.query;

  // التحقق من البيانات
  if (!ip || !port) {
    return res.status(400).json({ error: 'ip و port مطلوبان' });
  }

  let portNum;
  try {
    portNum = parseInt(port);
    if (portNum < 1 || portNum > 65535) {
      return res.status(400).json({ error: 'port غير صالح (1-65535)' });
    }
  } catch {
    return res.status(400).json({ error: 'port يجب أن يكون رقم' });
  }

  // محاكاة الـ attack (Serverless لا يدعم threads حقيقية)
  // في Vercel: timeout = 10s max، memory = 1024MB max
  try {
    // محاكاة UDP flood لمدة قصيرة (5 ثواني max في serverless)
    await simulateUdpFlood(ip, portNum, 5000);
    
    res.status(200).json({
      status: 'ok',
      message: محاكاة UDP flood انتهت → ${ip}:${portNum},
      duration: 5,
      warning: 'هذا تعليمي فقط - Serverless محدود'
    });
  } catch (error) {
    res.status(500).json({ error: 'خطأ في المحاكاة', details: error.message });
  }
}

// محاكاة UDP flood (لا تؤثر على الشبكات الحقيقية في serverless)
async function simulateUdpFlood(ip, port, duration) {
  return new Promise((resolve) => {
    const endTime = Date.now() + duration;
    let packets = 0;
    
    const interval = setInterval(() => {
      if (Date.now() > endTime) {
        clearInterval(interval);
        console.log(أرسلت ${packets} حزمة وهمية);
        resolve(packets);
        return;
      }
      
      // محاكاة إرسال packet (لا يرسل فعلياً في serverless)
      packets++;
      console.log(Packet #${packets} → ${ip}:${port});
    }, 10); // 100 packet/sec simulation
  });
}
